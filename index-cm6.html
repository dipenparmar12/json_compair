<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="theme-color" content="#08C988" />
    <title>Compare JSON files online - CodeMirror 6</title>
    <meta
      name="Description"
      content="FREE two-way JSON format, diff and merge tool with CodeMirror 6"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0"
    />
    <link rel="shortcut icon" href="./img/onlinetextcompare.png" />
    <link rel="stylesheet" href="./css/ccsiteV6.css" />
    <link rel="stylesheet" type="text/css" href="./css/app.css" />

    <!-- pako for client-side gzip compression/decompression - v2.1.0 (latest) -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- diff_match_patch for accurate diff counting -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/diff-match-patch/1.0.5/index.min.js"
      crossorigin="anonymous"
    ></script>

    <!-- Utility scripts -->
    <script src="./utils.js"></script>
    <script src="./json_utils.js"></script>
    <script src="./utils_csv.js"></script>

    <!-- ES Module Import Map for CodeMirror 6 - Using unpkg with exact versions -->
    <script type="importmap">
      {
        "imports": {
          "@codemirror/state": "https://unpkg.com/@codemirror/state@6.4.1/dist/index.js",
          "@codemirror/view": "https://unpkg.com/@codemirror/view@6.34.1/dist/index.js",
          "@codemirror/language": "https://unpkg.com/@codemirror/language@6.10.3/dist/index.js",
          "@codemirror/commands": "https://unpkg.com/@codemirror/commands@6.7.1/dist/index.js",
          "@codemirror/lang-json": "https://unpkg.com/@codemirror/lang-json@6.0.1/dist/index.js",
          "@codemirror/merge": "https://unpkg.com/@codemirror/merge@6.7.2/dist/index.js",
          "@codemirror/search": "https://unpkg.com/@codemirror/search@6.5.6/dist/index.js",
          "@codemirror/autocomplete": "https://unpkg.com/@codemirror/autocomplete@6.18.1/dist/index.js",
          "@codemirror/lint": "https://unpkg.com/@codemirror/lint@6.8.2/dist/index.js",
          "@lezer/common": "https://unpkg.com/@lezer/common@1.2.2/dist/index.js",
          "@lezer/highlight": "https://unpkg.com/@lezer/highlight@1.2.1/dist/index.js",
          "@lezer/lr": "https://unpkg.com/@lezer/lr@1.4.2/dist/index.js",
          "@lezer/json": "https://unpkg.com/@lezer/json@1.0.2/dist/index.js",
          "codemirror": "https://unpkg.com/codemirror@6.0.1/dist/index.js",
          "crelt": "https://unpkg.com/crelt@1.0.6/index.js",
          "style-mod": "https://unpkg.com/style-mod@4.1.2/src/style-mod.js",
          "w3c-keyname": "https://unpkg.com/w3c-keyname@2.2.8/index.js"
        }
      }
    </script>

    <style>
      * {
        box-sizing: border-box;
      }
      
      #container {
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      .intro {
        padding: 5px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      #view-container {
        flex: 1;
        overflow: hidden;
        position: relative;
        min-height: 0; /* Important for flex child scrolling */
        display: flex;
        flex-direction: row;
      }

      /* Button styles */
      button {
        padding: 6px 14px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: all 0.2s;
      }

      button:hover {
        background: #f5f5f5;
        border-color: #999;
      }

      button.active {
        background: #08c988;
        color: white;
        border-color: #08c988;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Pane-specific buttons */
      .pane-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        font-size: 12px;
        padding: 4px 10px;
      }

      .copy-btn {
        display: none;
      }

      /* CodeMirror 6 custom styling */
      .cm-editor {
        height: 100%;
        font-size: 14px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      }

      .cm-scroller {
        overflow: auto;
      }

      /* Merge view styling - Fixed to match actual DOM structure */
      .cm-mergeView {
        height: 100% !important;
        width: 100% !important;
        display: flex !important;
        flex-direction: row !important;
        flex: 1;
      }

      /* The wrapper that contains both editors */
      .cm-mergeViewEditors {
        display: flex !important;
        flex-direction: row !important;
        width: 100% !important;
        height: 100% !important;
        gap: 2px;
        flex: 1;
      }

      /* Force each editor to be exactly 50% */
      .cm-mergeViewEditor {
        flex: 1 1 50% !important;
        width: 50% !important;
        max-width: 50% !important;
        min-width: 0 !important; /* Critical: allows shrinking below content size */
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden !important; /* Prevent overflow from breaking layout */
        position: relative;
      }

      /* Editor container within each panel */
      .cm-mergeView .cm-editor {
        height: 100% !important;
        width: 100% !important;
        max-width: 100% !important;
        overflow: hidden !important;
      }

      /* Scroller must respect parent constraints */
      .cm-mergeView .cm-scroller {
        overflow: auto !important;
        width: 100% !important;
        max-width: 100% !important;
        min-width: 0 !important;
        height: 100% !important;
      }

      /* Prevent content from forcing panel expansion */
      .cm-mergeView .cm-content {
        min-width: 0 !important;
        max-width: 100% !important;
        width: 100% !important;
      }

      /* Ensure lines don't stretch the container */
      .cm-mergeView .cm-line {
        max-width: 100% !important;
      }

      /* Word wrap specific styles */
      .cm-mergeView .cm-line[style*="white-space: pre-wrap"] {
        max-width: 100% !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
      }

      /* No wrap mode - ensure horizontal scrolling */
      .cm-mergeView .cm-line[style*="white-space: pre"] {
        max-width: none; /* Allow line to extend for scrolling */
        white-space: pre !important;
      }

      /* Diff highlighting (similar to CM5 red/green scheme) */
      .cm-deletedChunk {
        background-color: #FFC4C1 !important;
      }

      .cm-insertedChunk {
        background-color: #B5EFDB !important;
      }

      .cm-changedLine {
        background-color: #fff3cd !important;
      }

      .cm-deletedText {
        background-color: #FF8983 !important;
        text-decoration: none !important;
      }

      .cm-insertedText {
        background-color: #6BDFB8 !important;
        text-decoration: none !important;
      }

      /* Status bar */
      #diff-status {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 8px 16px;
        background: #f8f9fa;
        border-top: 1px solid #ddd;
        font-size: 13px;
        color: #333;
        z-index: 1000;
      }

      /* Error message area */
      #conversion-error-area {
        position: fixed;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        background: #ff4444;
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        display: none;
        z-index: 2000;
        max-width: 80%;
        text-align: center;
      }

      /* Per-pane action buttons */
      .pane-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 100;
        display: flex;
        gap: 5px;
      }

      .pane-controls button {
        font-size: 11px;
        padding: 4px 8px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 3px;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
      }

      .pane-controls button:hover {
        opacity: 1;
        background: #f5f5f5;
      }

      .pane-wrapper {
        position: relative;
        flex: 1;
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .intro {
          flex-wrap: wrap;
        }

        button {
          font-size: 12px;
          padding: 5px 10px;
        }

        .pane-controls button {
          font-size: 10px;
          padding: 3px 6px;
        }
      }

    </style>
  </head>

  <body>
    <div id="container">
      <div class="intro">
        <button id="btn-format">Format JSON</button>
        <button id="btn-sort">Sort Keys</button>
        <button id="btn-word-wrap" class="active">ðŸ“„ Word Wrap</button>
        <button id="btn-share">ðŸ“‹ Share URL</button>
        <button id="btn-import">Import Snapshot</button>
        <input type="file" id="file-import" accept=".gz,.gzip,application/gzip,application/octet-stream,.json" style="display: none" />
        <select id="select-templates">
          <option value="">Examples...</option>
          <option value="simple">Simple Template</option>
          <option value="complex">Complex Template</option>
        </select>
        <label style="margin-left: 10px; font-size: 13px;">
          <input type="checkbox" id="auto-csv-conversion" /> Auto CSVâ†’JSON
        </label>
        <button id="btn-clear-all" style="display: none">Clear All</button>
        <span style="margin-left: auto; font-size: 13px; color: #666">
          <strong style="margin-right: 10px;">JsonCompair</strong>
          <a href="https://github.com/dipenparmar12/json_compair" target="_blank" rel="noopener noreferrer">
            <img src="https://github.githubassets.com/images/modules/site/icons/footer/github-mark.svg" alt="GitHub" width="16" height="16" style="vertical-align: middle; margin-right: 5px;"> - Dipenparmar12
          </a>
          
        </span>
      </div>

      <div id="view-container"></div>

      <div id="conversion-error-area" style="display: none"></div>
      <div id="diff-status">Ready to compare JSON</div>
    </div>

    <script type="module">
      // Import CodeMirror 6 core and extensions
      import { EditorView } from "@codemirror/view";
      import { EditorState } from "@codemirror/state";
      import { json } from "@codemirror/lang-json";
      import { MergeView } from "@codemirror/merge";
      import {
        lineNumbers,
        highlightActiveLineGutter,
        highlightSpecialChars,
        drawSelection,
        dropCursor,
        rectangularSelection,
        crosshairCursor,
        highlightActiveLine,
        keymap,
      } from "@codemirror/view";
      import {
        foldGutter,
        indentOnInput,
        syntaxHighlighting,
        defaultHighlightStyle,
        bracketMatching,
        foldKeymap,
      } from "@codemirror/language";
      import {
        history,
        defaultKeymap,
        historyKeymap,
      } from "@codemirror/commands";
      import {
        highlightSelectionMatches,
        searchKeymap,
      } from "@codemirror/search";
      import {
        closeBrackets,
        autocompletion,
        closeBracketsKeymap,
        completionKeymap,
      } from "@codemirror/autocomplete";
      import { lintKeymap } from "@codemirror/lint";

      // Import Compartment for dynamic configuration
      import { Compartment } from "@codemirror/state";

      // Word wrap compartment for dynamic reconfiguration
      const wordWrapCompartment = new Compartment();
      let wordWrapEnabled = true; // Default to enabled

      // Basic editor extensions for both sides
      const basicSetup = [
        lineNumbers(),
        highlightActiveLineGutter(),
        highlightSpecialChars(),
        history(),
        foldGutter(),
        drawSelection(),
        dropCursor(),
        EditorState.allowMultipleSelections.of(true),
        indentOnInput(),
        syntaxHighlighting(defaultHighlightStyle, { fallback: true }),
        bracketMatching(),
        closeBrackets(),
        autocompletion(),
        rectangularSelection(),
        crosshairCursor(),
        highlightActiveLine(),
        highlightSelectionMatches(),
        keymap.of([
          ...closeBracketsKeymap,
          ...defaultKeymap,
          ...searchKeymap,
          ...historyKeymap,
          ...foldKeymap,
          ...completionKeymap,
          ...lintKeymap,
        ]),
      ];

      // Global reference to merge view
      let mergeView = null;

      // Initialize the application
      function initializeApp() {
        // Load content from URL parameters first, then from storage, then use defaults
        const urlContent = URLManager.loadFromURL();
        const savedContent = StorageManager.loadFromStorage();
        const initialContent = urlContent || savedContent || DefaultTemplates.simple;

        // Create merge view container
        const container = document.getElementById("view-container");

        // Create merge view with CodeMirror 6
        // Use 'connect: "align"' to show empty placeholder blocks for unmatched chunks
        mergeView = new MergeView({
          a: {
            doc: initialContent.left,
            extensions: [basicSetup, json(), wordWrapCompartment.of(EditorView.lineWrapping)],
          },
          b: {
            doc: initialContent.right,
            extensions: [basicSetup, json(), wordWrapCompartment.of(EditorView.lineWrapping)],
          },
          parent: container,
          // Align matching lines and leave empty blocks for unmatched chunks (Git-like split view)
          connect: "align",
          // Keep identical lines visible so placeholders show in context
          collapseIdentical: false,
          // Highlight differences at character-level when possible
          highlightDifferences: true,
          // Show gutter markers
          gutter: true,
          // Allow editing both sides
          allowEditingOriginals: true,
          // Orientation a-b (left vs right)
          orientation: "a-b",
        });

        // Add per-pane control buttons
        addPaneControls();

        // Setup synchronized scrolling
        setupSynchronizedScrolling();

        // Set up button event handlers
        setupButtons();

        // Set up auto-save
        setupAutoSave();

        // Clear URL parameters if content was loaded from URL (keep URL clean)
        if (urlContent) {
          URLManager.clearURL();
          console.log('URL parameters cleared after loading content from URL');
        }

        // Update diff status initially
        updateDiffStatus();
      }

      // Add per-pane control buttons
      function addPaneControls() {
        // Find the editor elements
        const editors = document.querySelectorAll('.cm-mergeViewEditor');
        
        if (editors.length >= 2) {
          // Left pane controls
          addControlsToPane(editors[0], 'left');
          // Right pane controls
          addControlsToPane(editors[1], 'right');
        }
      }

      function addControlsToPane(paneElement, side) {
        const controls = document.createElement('div');
        controls.className = 'pane-controls';

        // Copy button
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'ðŸ“‹ Copy';
        copyBtn.title = 'Copy content';
        copyBtn.onclick = async () => {
          const editor = side === 'left' ? mergeView.a : mergeView.b;
          const text = editor.state.doc.toString();
          try {
            await navigator.clipboard.writeText(text);
            copyBtn.textContent = 'âœ“ Copied';
            setTimeout(() => { copyBtn.textContent = 'ðŸ“‹ Copy'; }, 1500);
          } catch (err) {
            updateStatus('Failed to copy: ' + err.message);
          }
        };

        // Paste button
        const pasteBtn = document.createElement('button');
        pasteBtn.textContent = 'ðŸ“„ Paste';
        pasteBtn.title = 'Paste from clipboard';
        pasteBtn.onclick = async () => {
          try {
            const text = await navigator.clipboard.readText();
            const editor = side === 'left' ? mergeView.a : mergeView.b;
            
            // Check for CSV and auto-convert if enabled
            const isCSV = window.CSVUtils && window.CSVUtils.isCSV(text);
            const autoCSV = document.getElementById('auto-csv-conversion')?.checked;

            let content = text;
            if (isCSV && autoCSV) {
              try {
                const jsonData = await window.CSVUtils.csvToJSONAsync(text, { coerceTypes: true });
                content = JSON.stringify(jsonData, null, 3);
                showConversionMessage("CSV converted to JSON");
              } catch (err) {
                showErrorMessage("CSV conversion failed: " + err.message);
              }
            }

            editor.dispatch({
              changes: { from: 0, to: editor.state.doc.length, insert: content }
            });
            updateDiffStatus();
          } catch (err) {
            updateStatus('Failed to paste: ' + err.message);
          }
        };

        // Clear button
        const clearBtn = document.createElement('button');
        clearBtn.textContent = 'ðŸ—‘ Clear';
        clearBtn.title = 'Clear content';
        clearBtn.onclick = () => {
          const editor = side === 'left' ? mergeView.a : mergeView.b;
          editor.dispatch({
            changes: { from: 0, to: editor.state.doc.length, insert: "" }
          });
          updateDiffStatus();
        };

        controls.appendChild(copyBtn);
        controls.appendChild(pasteBtn);
        controls.appendChild(clearBtn);
        
        paneElement.style.position = 'relative';
        paneElement.appendChild(controls);
      }

      // Setup synchronized scrolling
      function setupSynchronizedScrolling() {
        let scrollLocked = true;
        let isScrolling = false;

        // Get scroll containers
        const leftScroller = mergeView.a.scrollDOM;
        const rightScroller = mergeView.b.scrollDOM;

        // Sync scroll from left to right
        leftScroller.addEventListener('scroll', () => {
          if (!scrollLocked || isScrolling) return;
          isScrolling = true;
          rightScroller.scrollTop = leftScroller.scrollTop;
          rightScroller.scrollLeft = leftScroller.scrollLeft;
          setTimeout(() => { isScrolling = false; }, 10);
        });

        // Sync scroll from right to left
        rightScroller.addEventListener('scroll', () => {
          if (!scrollLocked || isScrolling) return;
          isScrolling = true;
          leftScroller.scrollTop = rightScroller.scrollTop;
          leftScroller.scrollLeft = rightScroller.scrollLeft;
          setTimeout(() => { isScrolling = false; }, 10);
        });

        // Add scroll lock toggle button
        const scrollLockBtn = document.createElement('button');
        scrollLockBtn.textContent = 'ðŸ”— Scroll Lock';
        scrollLockBtn.className = 'active';
        scrollLockBtn.title = 'Toggle synchronized scrolling';
        scrollLockBtn.onclick = () => {
          scrollLocked = !scrollLocked;
          scrollLockBtn.classList.toggle('active');
          scrollLockBtn.textContent = scrollLocked ? 'ðŸ”— Scroll Lock' : 'ðŸ”“ Scroll Unlocked';
        };

        // Add to intro controls
        const intro = document.querySelector('.intro');
        const clearBtn = document.getElementById('btn-clear-all');
        if (clearBtn) {
          intro.insertBefore(scrollLockBtn, clearBtn);
        } else {
          intro.appendChild(scrollLockBtn);
        }
      }

      // Setup button handlers
      function setupButtons() {
        const btnFormat = document.getElementById("btn-format");
        const btnSort = document.getElementById("btn-sort");
        const btnWordWrap = document.getElementById("btn-word-wrap");
        const btnShare = document.getElementById("btn-share");
        const btnImport = document.getElementById("btn-import");
        const fileImport = document.getElementById("file-import");
        const selectTemplates = document.getElementById("select-templates");
        const btnClearAll = document.getElementById("btn-clear-all");
        const autoCSV = document.getElementById("auto-csv-conversion");

        btnFormat.onclick = formatJSON;
        btnSort.onclick = sortJSON;
        
        // Word wrap toggle
        if (btnWordWrap) {
          btnWordWrap.onclick = () => {
            wordWrapEnabled = !wordWrapEnabled;
            btnWordWrap.classList.toggle('active');
            btnWordWrap.textContent = wordWrapEnabled ? 'ðŸ“„ Word Wrap' : 'ðŸ“ No Wrap';
            
            // Update both editors simultaneously
            const wrapExtension = wordWrapEnabled ? EditorView.lineWrapping : [];
            
            mergeView.a.dispatch({
              effects: wordWrapCompartment.reconfigure(wrapExtension)
            });
            
            mergeView.b.dispatch({
              effects: wordWrapCompartment.reconfigure(wrapExtension)
            });
            
            updateStatus(wordWrapEnabled ? 'Word wrap enabled' : 'Word wrap disabled');
          };
        }
        
        btnShare.onclick = shareURL;
        
        // Import snapshot
        btnImport.onclick = () => fileImport.click();
        fileImport.onchange = importSnapshot;

        // Template selection
        selectTemplates.onchange = (e) => {
          const templateName = e.target.value;
          if (templateName) {
            loadTemplate(templateName);
            e.target.value = ""; // Reset selection
          }
        };

        // Auto CSV conversion
        if (autoCSV) {
          const savedSetting = SettingsManager.get('autoCsv');
          autoCSV.checked = !!savedSetting;
          autoCSV.addEventListener('change', (e) => {
            SettingsManager.set('autoCsv', e.target.checked);
          });
        }
        
        if (btnClearAll) {
          btnClearAll.onclick = clearAll;
          updateClearButtonVisibility();
        }

        // Setup drag and drop handlers
        setupDragDrop();

        // Setup paste handlers
        setupPasteHandlers();
      }

      // Format JSON in both editors
      function formatJSON() {
        const leftContent = mergeView.a.state.doc.toString().trim();
        const rightContent = mergeView.b.state.doc.toString().trim();

        if (!leftContent || !rightContent) {
          updateStatus("Please provide content in both panels");
          return;
        }

        try {
          const leftParsed = window.parseFlexibleJSON(leftContent);
          const rightParsed = window.parseFlexibleJSON(rightContent);

          const leftFormatted = JSON.stringify(leftParsed, null, 3);
          const rightFormatted = JSON.stringify(rightParsed, null, 3);

          mergeView.a.dispatch({
            changes: { from: 0, to: mergeView.a.state.doc.length, insert: leftFormatted }
          });

          mergeView.b.dispatch({
            changes: { from: 0, to: mergeView.b.state.doc.length, insert: rightFormatted }
          });

          updateStatus("Formatted successfully");
          updateDiffStatus();
        } catch (e) {
          updateStatus("Error formatting: " + e.message);
        }
      }

      // Sort JSON keys
      function sortJSON() {
        const leftContent = mergeView.a.state.doc.toString().trim();
        const rightContent = mergeView.b.state.doc.toString().trim();

        if (!leftContent || !rightContent) {
          updateStatus("Please provide content in both panels");
          return;
        }

        try {
          const leftParsed = window.parseFlexibleJSON(leftContent);
          const rightParsed = window.parseFlexibleJSON(rightContent);

          const leftSorted = window.sortJSONKeys(leftParsed);
          const rightSorted = window.sortJSONKeys(rightParsed);

          const leftFormatted = JSON.stringify(leftSorted, null, 3);
          const rightFormatted = JSON.stringify(rightSorted, null, 3);

          mergeView.a.dispatch({
            changes: { from: 0, to: mergeView.a.state.doc.length, insert: leftFormatted }
          });

          mergeView.b.dispatch({
            changes: { from: 0, to: mergeView.b.state.doc.length, insert: rightFormatted }
          });

          updateStatus("Sorted successfully");
          updateDiffStatus();
        } catch (e) {
          updateStatus("Error sorting: " + e.message);
        }
      }

      // Share URL functionality
      async function shareURL() {
        const leftContent = mergeView.a.state.doc.toString();
        const rightContent = mergeView.b.state.doc.toString();

        if (!leftContent.trim() && !rightContent.trim()) {
          updateStatus("No content to share");
          return;
        }

        const btn = document.getElementById("btn-share");
        const originalText = btn.textContent;
        btn.textContent = 'â³ Processing...';
        btn.disabled = true;

        try {
          // Try to create compressed URL
          const shareableURL = URLManager.generateShareableURL(leftContent, rightContent);
          
          // Check URL length (browser limit ~2000 chars)
          if (shareableURL.length > 2000) {
            // Fall back to snapshot download
            const data = JSON.stringify({ left: leftContent, right: rightContent });
            const compressed = pako.gzip(data);
            const blob = new Blob([compressed], { type: 'application/gzip' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'json-compare-snapshot.json.gz';
            a.click();
            URL.revokeObjectURL(url);
            
            updateStatus("Content too large for URL - snapshot downloaded");
            btn.textContent = originalText;
            btn.disabled = false;
            return;
          }

          // Copy to clipboard
          await navigator.clipboard.writeText(shareableURL);
          btn.textContent = 'âœ“ Copied!';
          updateStatus("Share URL copied to clipboard");

          setTimeout(() => {
            btn.textContent = originalText;
            btn.disabled = false;
          }, 2000);
        } catch (err) {
          updateStatus("Failed to create share URL: " + err.message);
          btn.textContent = originalText;
          btn.disabled = false;
        }
      }

      // Import snapshot file
      async function importSnapshot(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;

        try {
          const arrayBuffer = await file.arrayBuffer();
          const uint8Array = new Uint8Array(arrayBuffer);
          
          let decompressed;
          try {
            decompressed = pako.ungzip(uint8Array, { to: 'string' });
          } catch (err) {
            // Try treating as uncompressed JSON
            const decoder = new TextDecoder();
            decompressed = decoder.decode(uint8Array);
          }

          const data = JSON.parse(decompressed);
          
          mergeView.a.dispatch({
            changes: { from: 0, to: mergeView.a.state.doc.length, insert: data.left || "" }
          });

          mergeView.b.dispatch({
            changes: { from: 0, to: mergeView.b.state.doc.length, insert: data.right || "" }
          });

          URLManager.clearURL();
          updateStatus("Snapshot imported successfully");
          updateDiffStatus();
        } catch (err) {
          updateStatus("Failed to import snapshot: " + err.message);
        } finally {
          e.target.value = ""; // Reset file input
        }
      }

      // Setup drag and drop handlers
      function setupDragDrop() {
        const leftEditor = mergeView.a.dom;
        const rightEditor = mergeView.b.dom;

        setupEditorDrop(leftEditor, 'left');
        setupEditorDrop(rightEditor, 'right');
      }

      function setupEditorDrop(editorElement, side) {
        editorElement.addEventListener('dragover', (e) => {
          e.preventDefault();
          e.stopPropagation();
          e.dataTransfer.dropEffect = 'copy';
        }, true);

        editorElement.addEventListener('drop', async (e) => {
          e.preventDefault();
          e.stopPropagation();

          const files = e.dataTransfer.files;
          if (files && files.length > 0) {
            await handleFileDrop(files[0], side);
          }
        }, true);
      }

      async function handleFileDrop(file, side) {
        try {
          const text = await file.text();
          const editor = side === 'left' ? mergeView.a : mergeView.b;

          // Check if it's CSV and auto-convert if enabled
          const isCSV = window.CSVUtils && window.CSVUtils.isCSV(text);
          const autoCSV = document.getElementById('auto-csv-conversion')?.checked;

          let content = text;
          if (isCSV && autoCSV) {
            try {
              const jsonData = await window.CSVUtils.csvToJSONAsync(text, { coerceTypes: true });
              content = JSON.stringify(jsonData, null, 3);
              showConversionMessage("CSV converted to JSON");
            } catch (err) {
              showErrorMessage("CSV conversion failed: " + err.message);
            }
          }

          editor.dispatch({
            changes: { from: 0, to: editor.state.doc.length, insert: content }
          });

          updateDiffStatus();
        } catch (err) {
          showErrorMessage("Failed to read file: " + err.message);
        }
      }

      // Setup paste handlers
      function setupPasteHandlers() {
        mergeView.a.dom.addEventListener('paste', (e) => handlePaste(e, 'left'), true);
        mergeView.b.dom.addEventListener('paste', (e) => handlePaste(e, 'right'), true);
      }

      async function handlePaste(e, side) {
        const clipboardData = e.clipboardData || window.clipboardData;
        if (!clipboardData) return;

        const text = clipboardData.getData('text');
        if (!text) return;

        const autoCSV = document.getElementById('auto-csv-conversion')?.checked;
        const isCSV = window.CSVUtils && window.CSVUtils.isCSV(text);

        if (isCSV && autoCSV) {
          e.preventDefault();
          e.stopPropagation();

          const editor = side === 'left' ? mergeView.a : mergeView.b;

          try {
            const jsonData = await window.CSVUtils.csvToJSONAsync(text, { coerceTypes: true });
            const content = JSON.stringify(jsonData, null, 3);

            editor.dispatch({
              changes: { from: 0, to: editor.state.doc.length, insert: content }
            });

            showConversionMessage("CSV converted to JSON");
            updateDiffStatus();
          } catch (err) {
            showErrorMessage("CSV conversion failed: " + err.message);
          }
        }
      }

      // Show conversion message
      function showConversionMessage(message) {
        updateStatus(message);
      }

      // Show error message
      function showErrorMessage(message) {
        const errorArea = document.getElementById('conversion-error-area');
        if (errorArea) {
          errorArea.textContent = message;
          errorArea.style.display = 'block';
          setTimeout(() => {
            errorArea.style.display = 'none';
          }, 6000);
        } else {
          updateStatus(message);
        }
      }

      // Load template
      function loadTemplate(templateName) {
        const template = DefaultTemplates[templateName];
        if (!template) return;

        const leftHas = mergeView.a.state.doc.toString().trim().length > 0;
        const rightHas = mergeView.b.state.doc.toString().trim().length > 0;

        if (leftHas || rightHas) {
          if (!confirm("This will replace current content. Continue?")) {
            return;
          }
        }

        mergeView.a.dispatch({
          changes: { from: 0, to: mergeView.a.state.doc.length, insert: template.left }
        });

        mergeView.b.dispatch({
          changes: { from: 0, to: mergeView.b.state.doc.length, insert: template.right }
        });

        updateStatus("Template loaded");
        updateDiffStatus();
      }

      // Clear all content
      function clearAll() {
        if (!confirm("Clear all content?")) return;

        mergeView.a.dispatch({
          changes: { from: 0, to: mergeView.a.state.doc.length, insert: "" }
        });

        mergeView.b.dispatch({
          changes: { from: 0, to: mergeView.b.state.doc.length, insert: "" }
        });

        updateStatus("Content cleared");
        updateDiffStatus();
      }

      // Auto-save to storage
      function setupAutoSave() {
        // Listen to changes in both editors
        mergeView.a.dom.addEventListener('input', saveContent);
        mergeView.b.dom.addEventListener('input', saveContent);
      }

      function saveContent() {
        const leftContent = mergeView.a.state.doc.toString();
        const rightContent = mergeView.b.state.doc.toString();

        try {
          StorageManager.saveToStorage(leftContent, rightContent);
        } catch (e) {
          console.warn('saveToStorage failed during autosave', e);
          if (StorageManager.saveToIndexedDB) {
            StorageManager.saveToIndexedDB(leftContent, rightContent).catch(err => {
              console.error('IndexedDB fallback failed:', err);
            });
          }
        }

        updateClearButtonVisibility();
        updateDiffStatus();
      }

      // Update diff status
      function updateDiffStatus() {
        const leftContent = mergeView.a.state.doc.toString().trim();
        const rightContent = mergeView.b.state.doc.toString().trim();
        const statusDiv = document.getElementById("diff-status");
        
        if (!leftContent || !rightContent) {
          statusDiv.textContent = "Add content to both panels to compare";
          return;
        }

        if (leftContent === rightContent) {
          statusDiv.textContent = "No differences found";
          return;
        }

        // Calculate actual differences using diff_match_patch if available
        if (typeof diff_match_patch !== 'undefined') {
          try {
            const dmp = new diff_match_patch();
            const diffs = dmp.diff_main(leftContent, rightContent);
            dmp.diff_cleanupSemantic(diffs);
            
            // Count number of diff chunks (contiguous blocks of changes)
            let diffCount = 0;
            let inDiffChunk = false;
            
            for (const [op, text] of diffs) {
              if (op !== 0) { // DIFF_INSERT (-1) or DIFF_DELETE (1)
                if (!inDiffChunk) {
                  diffCount++;
                  inDiffChunk = true;
                }
              } else { // DIFF_EQUAL (0)
                inDiffChunk = false;
              }
            }
            
            statusDiv.textContent = `Found ${diffCount} difference${diffCount !== 1 ? 's' : ''}`;
            return;
          } catch (err) {
            console.warn('Diff calculation failed:', err);
          }
        }

        // Fallback if diff_match_patch not available
        statusDiv.textContent = "Differences detected";
      }

      // Update status message
      function updateStatus(message) {
        const statusDiv = document.getElementById("diff-status");
        statusDiv.textContent = message;
      }

      // Update clear button visibility
      function updateClearButtonVisibility() {
        const btnClearAll = document.getElementById("btn-clear-all");
        if (!btnClearAll) return;

        const leftContent = mergeView.a.state.doc.toString().trim();
        const rightContent = mergeView.b.state.doc.toString().trim();

        btnClearAll.style.display = (leftContent || rightContent) ? "inline-block" : "none";
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }
    </script>
  </body>
</html>
