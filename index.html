<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="theme-color" content="#08C988" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="Online Text Compare" />
    <title>Compare JSON files online</title>
    <meta
      name="Description"
      content="FREE two-way JSON format, diff and merge tool. No Signup required. Nothing to install. All comparisons are 100% private, secure and happens locally right in your web browser"
    />
    <meta
      name="keywords"
      content="Online JSON Compare - Format and find differences between two JSON files"
    />
    <link
      rel="canonical"
      href="https://dipenparmar12.github.io/json_compair/"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0"
    />
    <link rel="shortcut icon" href="./img/onlinetextcompare.png" />
    <link rel="stylesheet" href="./css/ccsiteV6.css" />
    <link rel="stylesheet" type="text/css" href="./css/codemirror.css" />
    <link rel="stylesheet" type="text/css" href="./css/merge.css" />
    <link rel="stylesheet" type="text/css" href="./css/app.css" />
    <script src="./js/codemirror.js"></script>
    <script src="./js/diff_match_patch.js"></script>
    <script src="./js/merge.js"></script>
    <script src="./js/javascript.js"></script>
    <script src="./utils.js"></script>
    <script src="./json_utils.js"></script>
    <script src="./utils_csv.js"></script>
  </head>

  <body>
    <article id="ArticlePage" class="contentPage cover">
      <div
        class="intro"
        style="
          max-width: 100%;
          margin: 0;
          padding: 10px 0;
          text-align: center;
          background-color: #f8f9fa;
        "
      >
        <div class="controls">
          <button id="btn-format" class="toggle-button">
            Format &amp; Compare JSON
          </button>
          <!-- Additional controls will be added by JavaScript -->
        </div>
      </div>
    </article>
    <div id="container">
      <div id="view"></div>
      <div id="diff-status">Found 0 differences</div>
    </div>

    <script type="text/javascript">
    // Utilities are loaded from ./utils.js

  // parseFlexibleJSON is provided by `utils.js` and exposed on window.parseFlexibleJSON

      // Initialize enhanced merge view
      function initializeMergeView(target) {
        // Load content from URL parameters first, then from storage, then use defaults
        const urlContent = URLManager.loadFromURL();
        const savedContent = StorageManager.loadFromStorage();
        const initialContent = urlContent || savedContent || DefaultTemplates.simple;

        // Create merge view with enhanced options
        const mv = CodeMirror.MergeView(target, {
          value: initialContent.left,
          origLeft: null,
          orig: initialContent.right,
          lineNumbers: true,
          mode: "application/json",
          showDifferences: true,
          connect: "align",
          collapseIdentical: false,
          revertButtons: true,
          allowEditingOriginals: true,
          highlightDifferences: true,
          lineWrapping: true,
          styleActiveLine: true,
          chunkClassLocation: ["background", "wrap", "gutter"],
        });

        // Add scroll synchronization with toggle
        let scrollLocked = true;
        const leftEditor = mv.editor();
        const rightEditor = mv.rightOriginal();

        function syncScroll(sourceEditor, targetEditor) {
          if (!scrollLocked) return;
          const info = sourceEditor.getScrollInfo();
          targetEditor.scrollTo(info.left, info.top);
        }

        leftEditor.on("scroll", () => syncScroll(leftEditor, rightEditor));
        rightEditor.on("scroll", () => syncScroll(rightEditor, leftEditor));

        // Add UI controls
        const controls = document.querySelector(".controls");

          // Error message area (bottom) to show CSV conversion errors
          let errorArea = document.getElementById('conversion-error-area');
          if (!errorArea) {
            errorArea = document.createElement('div');
            errorArea.id = 'conversion-error-area';
            errorArea.style.cssText = 'color: #b00020; padding: 8px 10px; text-align: left; display: none;';
            document.body.appendChild(errorArea);
          }

        // Add scroll lock toggle
        const scrollLockBtn = document.createElement("button");
        scrollLockBtn.className = "toggle-button active";
        scrollLockBtn.textContent = "Scroll Lock";
        scrollLockBtn.onclick = () => {
          scrollLocked = !scrollLocked;
          scrollLockBtn.classList.toggle("active");
        };
        // controls.appendChild(scrollLockBtn);

        // Add Show Only Differences toggle
        const showDiffsBtn = document.createElement("button");
        showDiffsBtn.className = "toggle-button";
        showDiffsBtn.textContent = "Show Only Differences";

        showDiffsBtn.onclick = () => {
          showDiffsBtn.classList.toggle("active");
          const showOnlyDiffs = showDiffsBtn.classList.contains("active");

          const leftPane = leftEditor.getWrapperElement().parentNode;
          const rightPane = rightEditor.getWrapperElement().parentNode;

          leftPane.classList.toggle("show-diffs-only", showOnlyDiffs);
          rightPane.classList.toggle("show-diffs-only", showOnlyDiffs);

          // If showing diffs, ensure chunks are expanded
          if (showOnlyDiffs) {
            // Get all collapsed markers
            const markers = leftEditor.getAllMarks();
            markers.forEach((marker) => {
              if (marker.collapsed) {
                marker.clear();
              }
            });
          }

          // Refresh both editors
          leftEditor.refresh();
          rightEditor.refresh();

          // Adjust viewport to show first diff if exists
          if (showOnlyDiffs) {
            const chunks = mv.rightChunks();
            if (chunks && chunks.length > 0) {
              leftEditor.scrollIntoView({ line: chunks[0].from, ch: 0 }, 100);
            }
          }
        };
        controls.insertBefore(showDiffsBtn, scrollLockBtn.nextSibling);

        // Add Sort JSON Keys button
        const sortKeysBtn = document.createElement("button");
        sortKeysBtn.className = "toggle-button";
        sortKeysBtn.textContent = "Sort JSON Keys";
        sortKeysBtn.onclick = () => {
          try {
            // Parse and sort left editor content
            let leftObj = parseFlexibleJSON(leftEditor.getValue());
            if (Array.isArray(leftObj)) {
              leftObj = sortJSONArray(leftObj);
            } else {
              leftObj = sortJSONKeys(leftObj);
            }
            leftEditor.setValue(JSON.stringify(leftObj, null, 3));

            // Parse and sort right editor content
            let rightObj = parseFlexibleJSON(rightEditor.getValue());
            if (Array.isArray(rightObj)) {
              rightObj = sortJSONArray(rightObj);
            } else {
              rightObj = sortJSONKeys(rightObj);
            }
            rightEditor.setValue(JSON.stringify(rightObj, null, 3));

            // Realign chunks after sorting - fix the error
            setTimeout(() => {
              if (mv.alignChunks) {
                mv.alignChunks();
              }
              updateDiffStatus(mv);
            }, 0);
          } catch (e) {
            console.error("Failed to sort JSON:", e);
            alert(
              "Failed to sort JSON. Please ensure both sides contain valid JSON."
            );
          }
        };
        // Insert the sort button after the format button
        const formatBtn = document.getElementById("btn-format");
        controls.insertBefore(sortKeysBtn, formatBtn.nextSibling);

        // Add Share URL button
        const shareBtn = document.createElement("button");
        shareBtn.className = "toggle-button";
        shareBtn.textContent = "ðŸ“‹ Copy Share URL";
        shareBtn.onclick = async () => {
          const leftContent = leftEditor.getValue();
          const rightContent = rightEditor.getValue();
          
          if (!leftContent.trim() && !rightContent.trim()) {
            alert("Please add some content to share!");
            return;
          }
          
          const shareUrl = URLManager.generateShareableURL(leftContent, rightContent);
          
          try {
            await navigator.clipboard.writeText(shareUrl);
            // show temporary button text change
            const originalText = shareBtn.textContent;
            shareBtn.textContent = 'Copied';
            setTimeout(() => { shareBtn.textContent = originalText; }, 2000);
          } catch (err) {
            // Fallback for browsers that don't support clipboard API
            const textArea = document.createElement("textarea");
            textArea.value = shareUrl;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
      // show temporary button text change for fallback
      const originalText = shareBtn.textContent;
      shareBtn.textContent = 'Copied';
      setTimeout(() => { shareBtn.textContent = originalText; }, 2000);
          }
        };
    controls.insertBefore(shareBtn, sortKeysBtn.nextSibling);

        // Add template selector
        const templateSelect = document.createElement("select");
        templateSelect.className = "toggle-button";
        templateSelect.innerHTML = `
                <option value="simple">Simple Template</option>
                <option value="complex">Complex Template</option>
            `;
        templateSelect.onchange = () => {
          const template = DefaultTemplates[templateSelect.value];

          // Warn if either editor already has content
          const leftHas = leftEditor.getValue().trim().length > 0;
          const rightHas = rightEditor.getValue().trim().length > 0;

          if (leftHas || rightHas) {
            const proceed = confirm(
              'Loading this template will replace current editor content. Do you want to continue?'
            );
            if (!proceed) return; // Do nothing if user cancels
          }

          leftEditor.setValue(template.left);
          rightEditor.setValue(template.right);

          // Save to storage and update URL when loading template
          StorageManager.saveToStorage(template.left, template.right);
          URLManager.saveToURL(template.left, template.right);
        };
        controls.appendChild(templateSelect);

        // Add Clear All button
        const clearAllBtn = document.createElement("button");
        clearAllBtn.className = "toggle-button";
        clearAllBtn.textContent = "Clear All";
        clearAllBtn.style.display = "none"; // Initially hidden
        clearAllBtn.onclick = () => {
          leftEditor.setValue("");
          rightEditor.setValue("");
          URLManager.saveToURL("", ""); // Clear URL parameters
          updateDiffStatus(mv);
        };
        controls.appendChild(clearAllBtn);

        // Add individual clear buttons to each pane
        function addClearButton(editor, side) {
          const wrapper = editor.getWrapperElement();
          const clearBtn = document.createElement("button");
          clearBtn.className = `clear-btn clear-btn-${side}`;
          clearBtn.textContent = "Clear";
          clearBtn.style.display = "none"; // Initially hidden
          clearBtn.onclick = (e) => {
            e.stopPropagation();
            editor.setValue("");
            editor.focus(); // Focus the editor after clearing
            // Update URL when clearing individual editor
            setTimeout(() => {
              URLManager.saveToURL(leftEditor.getValue(), rightEditor.getValue());
            }, 0);
            updateDiffStatus(mv);
          };

          // Insert the button inside the editor's wrapper
          wrapper.parentNode.style.position = "relative";
          wrapper.parentNode.appendChild(clearBtn);

          return clearBtn;
        }

        // Add paste buttons to each pane
        function addPasteButton(editor, side) {
          const wrapper = editor.getWrapperElement();
          const pasteBtn = document.createElement("button");
          pasteBtn.className = `paste-btn paste-btn-${side}`;
          pasteBtn.textContent = "Paste from Clipboard";
          pasteBtn.style.display = "none"; // Initially hidden
          // Position paste button exactly where clear button is
          pasteBtn.style.top = "5px";
          pasteBtn.style.left = "unset";
          pasteBtn.style.right = "10px";
          pasteBtn.style.transform = "none";
          pasteBtn.style.padding = "3px 8px";
          pasteBtn.style.fontSize = "12px";
          pasteBtn.onclick = async (e) => {
            e.stopPropagation();
            try {
              // Request clipboard permission and get text
        const text = await navigator.clipboard.readText();
              if (text) {
                // If it looks like CSV, convert and replace editor content
                const looksLikeCSV = /[,;\t][^\n]*\n?/.test(text);
                if (looksLikeCSV && window.CSVUtils) {
                  try {
                    const jsonArray = window.CSVUtils.csvToJSON(text, { coerceTypes: true });
                    editor.setValue(JSON.stringify(jsonArray, null, 3));
                  } catch (err) {
                    // Fallback to raw paste and show error
                    editor.setValue(text);
                    showConversionError('CSV conversion failed: ' + (err && err.message ? err.message : String(err)));
                  }
                } else {
                  // Try to format if it's valid JSON
                  try {
                    const formatted = JSON.stringify(parseFlexibleJSON(text), null, 3);
                    editor.setValue(formatted);
                  } catch {
                    // If not valid JSON, just paste as-is
                    editor.setValue(text);
                  }
                }
                editor.focus();
                updateDiffStatus(mv);
              }
            } catch (err) {
              console.error("Clipboard permission denied:", err);
              alert("Please allow clipboard access to use the paste feature");
            }
          };

          // Insert the button inside the editor's wrapper
          wrapper.parentNode.appendChild(pasteBtn);

          return pasteBtn;
        }

        // Add clear buttons to both editors
        const leftClearBtn = addClearButton(leftEditor, "left");
        const rightClearBtn = addClearButton(rightEditor, "right");

        // Add paste buttons to both editors
        const leftPasteBtn = addPasteButton(leftEditor, "left");
        const rightPasteBtn = addPasteButton(rightEditor, "right");

        // Function to update button visibility based on content
        function updateClearButtonsVisibility() {
          const leftContent = leftEditor.getValue().trim();
          const rightContent = rightEditor.getValue().trim();

          // Individual clear/paste buttons
          if (leftContent) {
            leftClearBtn.style.display = "block";
            leftPasteBtn.style.display = "none";
          } else {
            leftClearBtn.style.display = "none";
            leftPasteBtn.style.display = "block";
          }
          if (rightContent) {
            rightClearBtn.style.display = "block";
            rightPasteBtn.style.display = "none";
          } else {
            rightClearBtn.style.display = "none";
            rightPasteBtn.style.display = "block";
          }

          // Clear All button - only visible if at least one editor has content
          clearAllBtn.style.display =
            leftContent || rightContent ? "inline-block" : "none";
        }

        // Set initial button visibility based on initial content
        updateClearButtonsVisibility();

        // Auto-save content changes and update URL
        const saveContent = () => {
          const leftContent = leftEditor.getValue();
          const rightContent = rightEditor.getValue();
          
          StorageManager.saveToStorage(leftContent, rightContent);
          
          // Update URL parameters for sharing (debounced)
          clearTimeout(saveContent.urlUpdateTimer);
          saveContent.urlUpdateTimer = setTimeout(() => {
            URLManager.saveToURL(leftContent, rightContent);
          }, 1000); // 1 second delay to avoid too frequent URL updates
          
          updateClearButtonsVisibility();
        };

        leftEditor.on("change", (instance, changeObj) => {
          if (changeObj.origin === "paste") {
            try {
              // Get pasted fragment (array of lines)
              const pastedText = (changeObj.text || []).join('\n');
              const looksLikeCSV = pastedText && /[,;\t][^\n]*\n?/.test(pastedText);
              if (looksLikeCSV && window.CSVUtils) {
                // Convert pasted CSV fragment to JSON and replace entire editor content
                try {
                  const jsonArray = window.CSVUtils.csvToJSON(pastedText, { coerceTypes: true });
                  instance.setValue(JSON.stringify(jsonArray, null, 3));
                } catch (err) {
                  // On conversion failure, leave the pasted CSV as-is and show error
                  showConversionError('CSV conversion failed: ' + (err && err.message ? err.message : String(err)));
                }
              } else {
                // Try to format if it's JSON-like (existing behavior)
                try {
                  var formatted = JSON.stringify(parseFlexibleJSON(instance.getValue()), null, 3);
                  instance.setValue(formatted);
                } catch (e) {
                  // Ignore parse errors
                }
              }
            } catch (e) {
              // Ignore any unexpected errors during paste handling
            }
          }
          saveContent();
          updateDiffStatus(mv);
        });

        rightEditor.on("change", (instance, changeObj) => {
          if (changeObj.origin === "paste") {
            try {
              const pastedText = (changeObj.text || []).join('\n');
              const looksLikeCSV = pastedText && /[,;\t][^\n]*\n?/.test(pastedText);
              if (looksLikeCSV && window.CSVUtils) {
                try {
                  const jsonArray = window.CSVUtils.csvToJSON(pastedText, { coerceTypes: true });
                  instance.setValue(JSON.stringify(jsonArray, null, 3));
                } catch (err) {
                  showConversionError('CSV conversion failed: ' + (err && err.message ? err.message : String(err)));
                }
              } else {
                try {
                  var formatted = JSON.stringify(parseFlexibleJSON(instance.getValue()), null, 3);
                  instance.setValue(formatted);
                } catch (e) {
                  // Ignore parse errors
                }
              }
            } catch (e) {
              // Ignore unexpected errors
            }
          }
          saveContent();
          updateDiffStatus(mv);
        });

        // Helper: show conversion error message temporarily
        function showConversionError(msg) {
          errorArea.textContent = msg;
          errorArea.style.display = 'block';
          setTimeout(() => {
            errorArea.style.display = 'none';
          }, 6000);
        }

        // Handle file drop on an editor: convert CSV -> JSON if applicable
        function handleEditorFileDrop(editor, files) {
          if (!files || files.length === 0) return;
          const file = files[0];
          const reader = new FileReader();
          reader.onerror = function (e) {
            showConversionError('Failed to read dropped file.');
          };
          reader.onload = function (e) {
            const text = e.target.result;

            // If file is CSV (by type or extension) or starts with typical CSV header, try conversion
            const name = file.name || '';
            const isCSVByName = name.toLowerCase().endsWith('.csv');
            const looksLikeCSV = text && /[,;\t][^\n]*\n/.test(text);

            if (isCSVByName || looksLikeCSV) {
              try {
                const jsonArray = window.CSVUtils.csvToJSON(text, { coerceTypes: true });
                // Replace editor content with formatted JSON
                editor.setValue(JSON.stringify(jsonArray, null, 3));

                // Save and update URL
                StorageManager.saveToStorage(leftEditor.getValue(), rightEditor.getValue());
                URLManager.saveToURL(leftEditor.getValue(), rightEditor.getValue());
                updateDiffStatus(mv);
              } catch (err) {
                console.error('CSV -> JSON conversion failed', err);
                showConversionError('CSV conversion failed: ' + (err && err.message ? err.message : String(err)));
                // Do not modify editor content on failure
              }
            } else {
              // Not CSV - just paste the text into the editor
              editor.setValue(text);
            }
          };
          reader.readAsText(file);
        }

        // Register native drop handlers on editor wrappers
        function registerDropOnEditor(editor, side) {
          const wrapper = editor.getWrapperElement();
          const parent = wrapper.parentNode;
          // Use capture phase and stop propagation so CodeMirror's internal drag/drop handlers don't also insert content
          parent.addEventListener('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
          }, true);

          parent.addEventListener('drop', function (e) {
            // Intercept in capture phase and prevent CodeMirror from handling the same event
            e.preventDefault();
            e.stopPropagation();
            if (e.stopImmediatePropagation) e.stopImmediatePropagation();

            const files = e.dataTransfer.files;
            if (files && files.length) {
              handleEditorFileDrop(editor, files);
            } else {
              // If plain text was dropped, read from dataTransfer and attempt conversion
              const text = e.dataTransfer.getData('text/plain');
              if (text) {
                const looksLikeCSV = /[,;\t][^\n]*\n?/.test(text);
                if (looksLikeCSV && window.CSVUtils) {
                  try {
                    const jsonArray = window.CSVUtils.csvToJSON(text, { coerceTypes: true });
                    editor.setValue(JSON.stringify(jsonArray, null, 3));
                  } catch (err) {
                    showConversionError('CSV conversion failed: ' + (err && err.message ? err.message : String(err)));
                    editor.setValue(text);
                  }
                } else {
                  editor.setValue(text);
                }
              }
            }
          }, true);

          // Intercept paste in capture phase to prevent CodeMirror from inserting raw CSV text first
          wrapper.addEventListener('paste', function (e) {
            try {
              const clipboardText = (e.clipboardData || window.clipboardData).getData('text/plain');
              if (!clipboardText) return;
              const looksLikeCSV = /[,;\t][^\n]*\n?/.test(clipboardText);
              if (looksLikeCSV && window.CSVUtils) {
                e.preventDefault();
                e.stopPropagation();
                if (e.stopImmediatePropagation) e.stopImmediatePropagation();
                try {
                  const jsonArray = window.CSVUtils.csvToJSON(clipboardText, { coerceTypes: true });
                  editor.setValue(JSON.stringify(jsonArray, null, 3));
                  // Update storage and URL
                  StorageManager.saveToStorage(leftEditor.getValue(), rightEditor.getValue());
                  URLManager.saveToURL(leftEditor.getValue(), rightEditor.getValue());
                  updateDiffStatus(mv);
                } catch (err) {
                  showConversionError('CSV conversion failed: ' + (err && err.message ? err.message : String(err)));
                }
              }
            } catch (err) {
              // ignore
            }
          }, true);
        }

        registerDropOnEditor(leftEditor, 'left');
        registerDropOnEditor(rightEditor, 'right');

        // Enhance format button
        document.getElementById("btn-format").onclick = function () {
          const leftContent = leftEditor.getValue().trim();
          const rightContent = rightEditor.getValue().trim();

          // Only proceed if both sides have content
          if (!leftContent || !rightContent) {
            document.getElementById("diff-status").textContent =
              "Please provide content in both panels";
            return;
          }

          try {
            leftEditor.setValue(JSON.stringify(parseFlexibleJSON(leftEditor.getValue()), null, 3));
            rightEditor.setValue(JSON.stringify(parseFlexibleJSON(rightEditor.getValue()), null, 3));
            mv.right.operation(() => {
              mv.alignChunks();
            });
          } catch (e) {
            // alert("Invalid JSON detected. Please check your input.");
          }
          updateDiffStatus(mv);
        };

        updateDiffStatus(mv);
        return mv;
      }

      function updateDiffStatus(mv) {
        const leftContent = mv.editor().getValue().trim();
        const rightContent = mv.rightOriginal().getValue().trim();

        // Only count differences if both sides have content
        if (!leftContent || !rightContent) {
          document.getElementById("diff-status").textContent =
            "Add JSON content to both sides to compare";
          return;
        }

        const diffs = mv.rightChunks().length;
        document.getElementById(
          "diff-status"
        ).textContent = `Found ${diffs} differences`;
      }

      // Initialize when DOM is ready
      document.addEventListener("DOMContentLoaded", () => {
        const target = document.getElementById("view");
        const mv = initializeMergeView(target);
        
  // No notification UI â€” intentionally removed to keep page free of toasts
      });
    </script>
  </body>
</html>
