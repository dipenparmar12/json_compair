<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Toolbox - Comprehensive JSON Utilities</title>
  <meta name="description" content="Comprehensive client-side JSON utilities: Schema Generator, Shaper, Linter, CSV Converter, Table Generator, Flattener, and Fuzzer">
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%2308c988'/%3E%3Ctext x='50' y='70' font-family='monospace' font-size='60' font-weight='bold' fill='white' text-anchor='middle'%3E%7B%7D%3C/text%3E%3C/svg%3E">
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/ccsiteV6.css">
  <link rel="stylesheet" href="css/app.css">
  
  <!-- CodeMirror 6 Import Map -->
  <script type="importmap">
  {
    "imports": {
      "@codemirror/view": "https://unpkg.com/@codemirror/view@6.35.3/dist/index.js",
      "@codemirror/state": "https://unpkg.com/@codemirror/state@6.5.2/dist/index.js",
      "@codemirror/language": "https://unpkg.com/@codemirror/language@6.11.0/dist/index.js",
      "@codemirror/commands": "https://unpkg.com/@codemirror/commands@6.8.0/dist/index.js",
      "@codemirror/search": "https://unpkg.com/@codemirror/search@6.5.10/dist/index.js",
      "@codemirror/autocomplete": "https://unpkg.com/@codemirror/autocomplete@6.18.6/dist/index.js",
      "@codemirror/lint": "https://unpkg.com/@codemirror/lint@6.8.5/dist/index.js",
      "@codemirror/lang-json": "https://unpkg.com/@codemirror/lang-json@6.0.1/dist/index.js",
      "@lezer/common": "https://unpkg.com/@lezer/common@1.2.3/dist/index.js",
      "@lezer/highlight": "https://unpkg.com/@lezer/highlight@1.2.1/dist/index.js",
      "@lezer/json": "https://unpkg.com/@lezer/json@1.0.3/dist/index.js",
      "@lezer/lr": "https://unpkg.com/@lezer/lr@1.4.2/dist/index.js",
      "@marijn/find-cluster-break": "https://unpkg.com/@marijn/find-cluster-break@1.0.2/src/index.js",
      "crelt": "https://unpkg.com/crelt@1.0.6/index.js",
      "style-mod": "https://unpkg.com/style-mod@4.1.2/src/style-mod.js",
      "w3c-keyname": "https://unpkg.com/w3c-keyname@2.2.8/index.js"
    }
  }
  </script>
  
  <!-- Utility Scripts -->
  <script src="utils/utils_core.js"></script>
  <script src="utils/schema_generator.js"></script>
  <script src="utils/json_shaper.js"></script>
  <script src="utils/json_linter.js"></script>
  <script src="utils/json_flattener.js"></script>
  <script src="utils/json_to_table.js"></script>
  <script src="utils/json_fuzzer.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Header -->
    <header class="app-header">
      <div class="app-logo">
        <div class="app-logo-icon">{}</div>
        <div class="app-logo-text">JSON <span>Toolbox</span></div>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary btn-sm" id="btn-clear" title="Clear Input">
          üóëÔ∏è Clear
        </button>
        <button class="btn btn-secondary btn-sm" id="btn-paste" title="Paste from Clipboard">
          üìã Paste
        </button>
        <button class="btn btn-secondary btn-sm" id="btn-sample" title="Load Sample Data">
          üìÑ Sample
        </button>
        <button class="btn btn-icon btn-secondary btn-sm" id="btn-theme" title="Toggle Theme">
          üåô
        </button>
      </div>
    </header>

    <!-- Tool Tabs -->
    <nav class="tool-tabs" role="tablist">
      <button class="tool-tab active" data-tool="schema" role="tab" aria-selected="true">
        <span class="tool-tab-icon">üìê</span>
        <span>Schema</span>
      </button>
      <button class="tool-tab" data-tool="shape" role="tab" aria-selected="false">
        <span class="tool-tab-icon">üîç</span>
        <span>Shape</span>
      </button>
      <button class="tool-tab" data-tool="lint" role="tab" aria-selected="false">
        <span class="tool-tab-icon">‚úÖ</span>
        <span>Lint</span>
      </button>
      <button class="tool-tab" data-tool="flatten" role="tab" aria-selected="false">
        <span class="tool-tab-icon">üìä</span>
        <span>Flatten</span>
      </button>
      <button class="tool-tab" data-tool="table" role="tab" aria-selected="false">
        <span class="tool-tab-icon">üìã</span>
        <span>Table</span>
      </button>
      <button class="tool-tab" data-tool="fuzz" role="tab" aria-selected="false">
        <span class="tool-tab-icon">üé≤</span>
        <span>Fuzz</span>
      </button>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="split-pane">
        <!-- Input Pane -->
        <div class="pane pane-input">
          <div class="pane-header">
            <span class="pane-title">Input JSON</span>
            <div class="pane-actions">
              <button class="btn btn-icon btn-sm btn-secondary tooltip" data-tooltip="Upload File" id="btn-upload">
                üìÅ
              </button>
              <button class="btn btn-icon btn-sm btn-secondary tooltip" data-tooltip="Format JSON" id="btn-format">
                ‚ú®
              </button>
              <button class="btn btn-icon btn-sm btn-secondary tooltip" data-tooltip="Minify JSON" id="btn-minify">
                üì¶
              </button>
            </div>
          </div>
          <div class="pane-body">
            <div class="editor-container" id="input-editor"></div>
            <div class="drop-zone" id="drop-zone">
              <div class="drop-zone-icon">üìÑ</div>
              <div class="drop-zone-text">Drop JSON file here</div>
            </div>
          </div>
        </div>

        <!-- Resizer -->
        <div class="pane-resizer" id="pane-resizer"></div>

        <!-- Output Pane -->
        <div class="pane pane-output">
          <div class="pane-header">
            <span class="pane-title" id="output-title">Schema Output</span>
            <div class="pane-actions">
              <button class="btn btn-icon btn-sm btn-secondary tooltip" data-tooltip="Copy Output" id="btn-copy">
                üìã
              </button>
              <button class="btn btn-icon btn-sm btn-secondary tooltip" data-tooltip="Download" id="btn-download">
                üíæ
              </button>
            </div>
          </div>
          <div class="pane-body">
            <div class="output-preview" id="output-area">
              <div class="empty-state">
                <div class="empty-state-icon">üìê</div>
                <div class="empty-state-title">Enter JSON to Generate Schema</div>
                <div class="empty-state-description">
                  Paste or type JSON in the input panel, and the schema will be generated automatically.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Options Panel -->
      <aside class="options-panel">
        <div class="options-header">
          <h3 class="options-title" id="options-tool-name">Schema Generator</h3>
          <p class="options-subtitle" id="options-tool-desc">Generate JSON Schema from sample data</p>
        </div>
        <div class="options-body">
          <!-- Schema Options (default visible) -->
          <div id="options-schema" class="tool-options">
            <div class="form-group">
              <label class="form-label">Schema Version</label>
              <select class="form-select" id="schema-version">
                <option value="draft-2020-12">Draft 2020-12 (Latest)</option>
                <option value="draft-07">Draft-07</option>
                <option value="draft-04">Draft-04</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="schema-required" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Include required fields</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="schema-examples" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Include examples</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="schema-formats" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Detect formats (email, URI, etc.)</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="schema-additional">
                <span class="toggle-switch"></span>
                <span class="toggle-label">Allow additional properties</span>
              </label>
            </div>
          </div>

          <!-- Shape Options -->
          <div id="options-shape" class="tool-options" style="display: none;">
            <div class="form-group">
              <label class="form-label">Output Mode</label>
              <select class="form-select" id="shape-mode">
                <option value="verbose">Verbose (Type annotations)</option>
                <option value="compact">Compact (Keys only)</option>
                <option value="compact-typed">Compact with types</option>
                <option value="tree">Tree structure</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="shape-stats">
                <span class="toggle-switch"></span>
                <span class="toggle-label">Show statistics</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-label">Max Depth <span class="form-label-hint">(0 = unlimited)</span></label>
              <div class="number-input-group">
                <input type="number" class="form-input" id="shape-depth" value="0" min="0" max="50">
              </div>
            </div>
          </div>

          <!-- Lint Options -->
          <div id="options-lint" class="tool-options" style="display: none;">
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="lint-autorepair" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Auto-repair issues</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="lint-format" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Format output</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="lint-sortkeys">
                <span class="toggle-switch"></span>
                <span class="toggle-label">Sort keys alphabetically</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-label">Indentation</label>
              <select class="form-select" id="lint-indent">
                <option value="2">2 spaces</option>
                <option value="3" selected>3 spaces</option>
                <option value="4">4 spaces</option>
                <option value="\t">Tab</option>
              </select>
            </div>
          </div>

          <!-- Flatten Options -->
          <div id="options-flatten" class="tool-options" style="display: none;">
            <div class="form-group">
              <label class="form-label">Operation</label>
              <select class="form-select" id="flatten-op">
                <option value="flatten">Flatten (nested ‚Üí flat)</option>
                <option value="unflatten">Unflatten (flat ‚Üí nested)</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Delimiter</label>
              <input type="text" class="form-input" id="flatten-delimiter" value="." placeholder=".">
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="flatten-arrays" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Include array indices</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="flatten-empty">
                <span class="toggle-switch"></span>
                <span class="toggle-label">Preserve empty objects/arrays</span>
              </label>
            </div>
          </div>

          <!-- Table Options -->
          <div id="options-table" class="tool-options" style="display: none;">
            <div class="form-group">
              <label class="form-label">Output Format</label>
              <select class="form-select" id="table-format">
                <option value="markdown">Markdown</option>
                <option value="html">HTML Table</option>
                <option value="expandable">Expandable HTML</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="table-flatten" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Flatten nested objects</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="table-header" checked>
                <span class="toggle-switch"></span>
                <span class="toggle-label">Include header row</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-label">Max Columns <span class="form-label-hint">(0 = unlimited)</span></label>
              <div class="number-input-group">
                <input type="number" class="form-input" id="table-maxcols" value="0" min="0" max="100">
              </div>
            </div>
          </div>

          <!-- Fuzz Options -->
          <div id="options-fuzz" class="tool-options" style="display: none;">
            <div class="form-group">
              <label class="form-label">Generation Mode</label>
              <select class="form-select" id="fuzz-mode">
                <option value="normal">Normal</option>
                <option value="edge">Edge Cases</option>
                <option value="stress">Stress Test</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Number of Samples</label>
              <div class="number-input-group">
                <input type="number" class="form-input" id="fuzz-count" value="5" min="1" max="100">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Seed <span class="form-label-hint">(optional, for reproducibility)</span></label>
              <input type="number" class="form-input" id="fuzz-seed" placeholder="Random">
            </div>
            <div class="form-group">
              <label class="form-toggle">
                <input type="checkbox" id="fuzz-fromschema">
                <span class="toggle-switch"></span>
                <span class="toggle-label">Input is JSON Schema</span>
              </label>
            </div>
          </div>
        </div>
        
        <div class="options-footer">
          <button class="btn btn-primary btn-block" id="btn-process">
            Generate Schema
          </button>
        </div>
      </aside>
    </main>

    <!-- Status Bar -->
    <footer class="status-bar">
      <div class="status-message" id="status-message">
        <span>Ready</span>
      </div>
      <div class="status-stats">
        <div class="status-stat" id="stat-size">
          <span>Size:</span>
          <strong>0 B</strong>
        </div>
        <div class="status-stat" id="stat-lines">
          <span>Lines:</span>
          <strong>0</strong>
        </div>
      </div>
    </footer>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="file-input" accept=".json,.txt" style="display: none;">

  <!-- Copy feedback -->
  <div class="copy-feedback" id="copy-feedback">Copied to clipboard!</div>

  <!-- Main Application Script -->
  <script type="module">
    import { EditorView, keymap, lineNumbers, highlightActiveLineGutter, highlightSpecialChars, drawSelection, dropCursor, rectangularSelection, crosshairCursor, highlightActiveLine } from '@codemirror/view';
    import { EditorState, Compartment } from '@codemirror/state';
    import { defaultKeymap, history, historyKeymap, indentWithTab } from '@codemirror/commands';
    import { foldGutter, indentOnInput, syntaxHighlighting, defaultHighlightStyle, bracketMatching, foldKeymap } from '@codemirror/language';
    import { searchKeymap, highlightSelectionMatches } from '@codemirror/search';
    import { autocompletion, completionKeymap, closeBrackets, closeBracketsKeymap } from '@codemirror/autocomplete';
    import { lintKeymap } from '@codemirror/lint';
    import { json } from '@codemirror/lang-json';

    // ============================================
    // Application State
    // ============================================
    const AppState = {
      currentTool: 'schema',
      theme: localStorage.getItem('json-toolbox-theme') || 'light',
      inputEditor: null,
      themeCompartment: new Compartment(),
      wordWrapCompartment: new Compartment(),
      debounceTimer: null
    };

    // Tool configurations
    const TOOLS = {
      schema: {
        name: 'Schema Generator',
        description: 'Generate JSON Schema Draft 2020-12 from sample data',
        outputTitle: 'Schema Output',
        buttonText: 'Generate Schema',
        emptyIcon: 'üìê',
        emptyTitle: 'Enter JSON to Generate Schema',
        emptyDesc: 'Paste or type JSON in the input panel, and the schema will be generated automatically.'
      },
      shape: {
        name: 'JSON Shaper',
        description: 'Visualize JSON structure without values',
        outputTitle: 'Structure Output',
        buttonText: 'Generate Shape',
        emptyIcon: 'üîç',
        emptyTitle: 'Enter JSON to View Structure',
        emptyDesc: 'Shows the structural outline of your JSON data with type annotations.'
      },
      lint: {
        name: 'JSON Linter',
        description: 'Validate, repair, and format JSON',
        outputTitle: 'Lint Results',
        buttonText: 'Lint & Format',
        emptyIcon: '‚úÖ',
        emptyTitle: 'Enter JSON to Validate',
        emptyDesc: 'Validates JSON syntax and can auto-repair common issues.'
      },
      flatten: {
        name: 'JSON Flattener',
        description: 'Convert nested JSON to flat dot-notation',
        outputTitle: 'Flattened Output',
        buttonText: 'Flatten JSON',
        emptyIcon: 'üìä',
        emptyTitle: 'Enter JSON to Flatten',
        emptyDesc: 'Converts deeply nested objects into flat key-value pairs.'
      },
      table: {
        name: 'Table Generator',
        description: 'Convert JSON arrays to Markdown/HTML tables',
        outputTitle: 'Table Output',
        buttonText: 'Generate Table',
        emptyIcon: 'üìã',
        emptyTitle: 'Enter JSON Array',
        emptyDesc: 'Converts arrays of objects into formatted tables.'
      },
      fuzz: {
        name: 'JSON Fuzzer',
        description: 'Generate random test data from schema or sample',
        outputTitle: 'Generated Data',
        buttonText: 'Generate Data',
        emptyIcon: 'üé≤',
        emptyTitle: 'Enter JSON or Schema',
        emptyDesc: 'Generates random valid JSON data based on input structure.'
      }
    };

    // Sample data
    const SAMPLE_DATA = {
      user: {
        id: 12345,
        name: "Alice Johnson",
        email: "alice.johnson@example.com",
        age: 28,
        active: true,
        registered: "2024-01-15T10:30:00Z",
        profile: {
          avatar: "https://example.com/avatars/alice.jpg",
          bio: "Software developer passionate about open source",
          location: {
            city: "San Francisco",
            country: "USA",
            coordinates: {
              lat: 37.7749,
              lng: -122.4194
            }
          }
        },
        roles: ["admin", "developer"],
        settings: {
          theme: "dark",
          notifications: {
            email: true,
            push: false,
            sms: true
          }
        }
      }
    };

    // ============================================
    // Theme Setup
    // ============================================
    const lightTheme = EditorView.theme({
      '&': { backgroundColor: '#ffffff' },
      '.cm-gutters': { backgroundColor: '#f8f9fa', borderRight: '1px solid #dee2e6' },
      '.cm-activeLine': { backgroundColor: 'rgba(8, 201, 136, 0.05)' }
    }, { dark: false });

    const darkTheme = EditorView.theme({
      '&': { backgroundColor: '#1e1e1e' },
      '.cm-gutters': { backgroundColor: '#252526', borderRight: '1px solid #404040' },
      '.cm-activeLine': { backgroundColor: 'rgba(255, 255, 255, 0.05)' },
      '.cm-content': { color: '#d4d4d4' }
    }, { dark: true });

    // ============================================
    // Editor Setup
    // ============================================
    function createEditor() {
      const basicExtensions = [
        lineNumbers(),
        highlightActiveLineGutter(),
        highlightSpecialChars(),
        history(),
        foldGutter(),
        drawSelection(),
        dropCursor(),
        EditorState.allowMultipleSelections.of(true),
        indentOnInput(),
        syntaxHighlighting(defaultHighlightStyle, { fallback: true }),
        bracketMatching(),
        closeBrackets(),
        autocompletion(),
        rectangularSelection(),
        crosshairCursor(),
        highlightActiveLine(),
        highlightSelectionMatches(),
        keymap.of([
          ...closeBracketsKeymap,
          ...defaultKeymap,
          ...searchKeymap,
          ...historyKeymap,
          ...foldKeymap,
          ...completionKeymap,
          ...lintKeymap,
          indentWithTab
        ]),
        json(),
        AppState.themeCompartment.of(AppState.theme === 'dark' ? darkTheme : lightTheme),
        AppState.wordWrapCompartment.of(EditorView.lineWrapping),
        EditorView.updateListener.of(update => {
          if (update.docChanged) {
            updateStats();
            debouncedProcess();
          }
        })
      ];

      const state = EditorState.create({
        doc: '',
        extensions: basicExtensions
      });

      AppState.inputEditor = new EditorView({
        state,
        parent: document.getElementById('input-editor')
      });
    }

    // ============================================
    // Tool Processing Functions
    // ============================================
    function processSchema(input, options = {}) {
      try {
        const data = JSON.parse(input);
        const schema = SchemaGenerator.inferSchema(data, {
          includeExamples: options.examples ?? true,
          detectFormats: options.formats ?? true,
          additionalProperties: options.additional ?? false
        });
        
        // Add $schema based on version
        const schemaVersions = {
          'draft-2020-12': 'https://json-schema.org/draft/2020-12/schema',
          'draft-07': 'http://json-schema.org/draft-07/schema#',
          'draft-04': 'http://json-schema.org/draft-04/schema#'
        };
        schema.$schema = schemaVersions[options.version] || schemaVersions['draft-2020-12'];
        
        return {
          success: true,
          output: JSON.stringify(schema, null, 3),
          stats: SchemaGenerator.getSchemaStats(schema)
        };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    function processShape(input, options = {}) {
      try {
        const data = JSON.parse(input);
        const result = JSONShaper.getStructure(data, {
          mode: options.mode || 'verbose',
          maxDepth: options.depth || 0,
          showStats: options.stats
        });
        
        let output;
        if (options.mode === 'tree') {
          output = JSON.stringify(result.tree, null, 3);
        } else if (options.mode === 'compact' || options.mode === 'compact-typed') {
          output = result.structure;
        } else {
          output = JSON.stringify(result.verboseObject, null, 3);
        }
        
        return {
          success: true,
          output,
          stats: result.stats
        };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    function processLint(input, options = {}) {
      const lintResult = JSONLinter.lint(input, {
        autoRepair: options.autorepair ?? true
      });
      
      if (lintResult.valid || lintResult.repaired) {
        const jsonToFormat = lintResult.repaired || input;
        
        if (options.format) {
          let parsed;
          try {
            parsed = JSON.parse(jsonToFormat);
          } catch (e) {
            return { success: false, error: 'Could not parse JSON: ' + e.message };
          }
          
          if (options.sortkeys) {
            parsed = JSONLinter.sortKeys(parsed).sorted;
          }
          
          const indent = options.indent === '\\t' ? '\t' : parseInt(options.indent) || 3;
          const formatted = JSON.stringify(parsed, null, indent);
          
          return {
            success: true,
            output: formatted,
            issues: lintResult.issues,
            repaired: !!lintResult.repaired
          };
        }
        
        return {
          success: true,
          output: jsonToFormat,
          issues: lintResult.issues
        };
      }
      
      return {
        success: false,
        error: 'Invalid JSON',
        issues: lintResult.issues
      };
    }

    function processFlatten(input, options = {}) {
      try {
        const data = JSON.parse(input);
        
        if (options.op === 'unflatten') {
          const result = JSONFlattener.unflatten(data, {
            delimiter: options.delimiter || '.'
          });
          return {
            success: true,
            output: JSON.stringify(result, null, 3)
          };
        }
        
        const flat = JSONFlattener.flatten(data, {
          delimiter: options.delimiter || '.',
          flattenArrays: options.arrays ?? true,
          preserveEmpty: options.empty ?? false
        });
        
        return {
          success: true,
          output: JSON.stringify(flat, null, 3),
          stats: JSONFlattener.getFlatStats(flat)
        };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    function processTable(input, options = {}) {
      try {
        const data = JSON.parse(input);
        
        const tableOptions = {
          flatten: options.flatten ?? true,
          includeHeader: options.header ?? true,
          maxColumns: options.maxcols || 0
        };
        
        let result;
        switch (options.format) {
          case 'html':
            result = JSONToTable.toHTMLTable(data, tableOptions);
            return { success: true, output: result.html, isHtml: true };
          case 'expandable':
            result = JSONToTable.toExpandableHTMLTable(data, tableOptions);
            return { success: true, output: result.html, isHtml: true };
          default:
            result = JSONToTable.toMarkdownTable(data, tableOptions);
            return { success: true, output: result.markdown };
        }
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    function processFuzz(input, options = {}) {
      try {
        const data = JSON.parse(input);
        const count = options.count || 5;
        const seed = options.seed ? parseInt(options.seed) : undefined;
        
        let results;
        if (options.fromschema) {
          // Input is a schema
          results = JSONFuzzer.generateMultiple(data, {
            count,
            seed,
            mode: options.mode || 'normal'
          });
        } else {
          // Input is sample data - infer schema first
          const schema = SchemaGenerator.inferSchema(data);
          results = JSONFuzzer.generateMultiple(schema, {
            count,
            seed,
            mode: options.mode || 'normal'
          });
        }
        
        return {
          success: true,
          output: JSON.stringify(results, null, 3)
        };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    // ============================================
    // Main Process Function
    // ============================================
    function process() {
      const input = AppState.inputEditor.state.doc.toString().trim();
      
      if (!input) {
        showEmptyState();
        return;
      }

      const tool = AppState.currentTool;
      let result;

      switch (tool) {
        case 'schema':
          result = processSchema(input, {
            version: document.getElementById('schema-version').value,
            required: document.getElementById('schema-required').checked,
            examples: document.getElementById('schema-examples').checked,
            formats: document.getElementById('schema-formats').checked,
            additional: document.getElementById('schema-additional').checked
          });
          break;
        case 'shape':
          result = processShape(input, {
            mode: document.getElementById('shape-mode').value,
            depth: parseInt(document.getElementById('shape-depth').value) || 0,
            stats: document.getElementById('shape-stats').checked
          });
          break;
        case 'lint':
          result = processLint(input, {
            autorepair: document.getElementById('lint-autorepair').checked,
            format: document.getElementById('lint-format').checked,
            sortkeys: document.getElementById('lint-sortkeys').checked,
            indent: document.getElementById('lint-indent').value
          });
          break;
        case 'flatten':
          result = processFlatten(input, {
            op: document.getElementById('flatten-op').value,
            delimiter: document.getElementById('flatten-delimiter').value,
            arrays: document.getElementById('flatten-arrays').checked,
            empty: document.getElementById('flatten-empty').checked
          });
          break;
        case 'table':
          result = processTable(input, {
            format: document.getElementById('table-format').value,
            flatten: document.getElementById('table-flatten').checked,
            header: document.getElementById('table-header').checked,
            maxcols: parseInt(document.getElementById('table-maxcols').value) || 0
          });
          break;
        case 'fuzz':
          result = processFuzz(input, {
            mode: document.getElementById('fuzz-mode').value,
            count: parseInt(document.getElementById('fuzz-count').value) || 5,
            seed: document.getElementById('fuzz-seed').value,
            fromschema: document.getElementById('fuzz-fromschema').checked
          });
          break;
      }

      displayResult(result);
    }

    function debouncedProcess() {
      clearTimeout(AppState.debounceTimer);
      AppState.debounceTimer = setTimeout(process, 300);
    }

    // ============================================
    // Display Functions
    // ============================================
    function displayResult(result) {
      const outputArea = document.getElementById('output-area');
      
      if (!result.success) {
        outputArea.innerHTML = `
          <div class="alert alert-error">
            <span class="alert-icon">‚ùå</span>
            <div class="alert-content">
              <strong>Error:</strong> ${escapeHtml(result.error)}
              ${result.issues ? renderIssues(result.issues) : ''}
            </div>
          </div>
        `;
        updateStatus('error', 'Processing failed');
        return;
      }

      if (result.isHtml) {
        outputArea.innerHTML = `<div class="table-output">${result.output}</div>`;
      } else {
        outputArea.innerHTML = `<pre class="output-preview formatted">${escapeHtml(result.output)}</pre>`;
      }

      if (result.repaired) {
        updateStatus('warning', 'JSON repaired successfully');
      } else {
        updateStatus('success', 'Processed successfully');
      }
    }

    function showEmptyState() {
      const tool = TOOLS[AppState.currentTool];
      document.getElementById('output-area').innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">${tool.emptyIcon}</div>
          <div class="empty-state-title">${tool.emptyTitle}</div>
          <div class="empty-state-description">${tool.emptyDesc}</div>
        </div>
      `;
      updateStatus('info', 'Ready');
    }

    function renderIssues(issues) {
      if (!issues || issues.length === 0) return '';
      return `
        <ul class="lint-issues" style="margin-top: 10px;">
          ${issues.map(issue => `
            <li class="lint-issue">
              <span class="lint-issue-icon ${issue.severity}">${
                issue.severity === 'error' ? '‚úï' : 
                issue.severity === 'warning' ? '‚ö†' : '‚Ñπ'
              }</span>
              <div class="lint-issue-content">
                <div class="lint-issue-message">${escapeHtml(issue.message)}</div>
                ${issue.line ? `<div class="lint-issue-location">Line ${issue.line}</div>` : ''}
              </div>
            </li>
          `).join('')}
        </ul>
      `;
    }

    function updateStatus(type, message) {
      const statusEl = document.getElementById('status-message');
      statusEl.className = `status-message ${type}`;
      statusEl.innerHTML = `<span>${message}</span>`;
    }

    function updateStats() {
      const content = AppState.inputEditor.state.doc.toString();
      const size = new Blob([content]).size;
      const lines = AppState.inputEditor.state.doc.lines;
      
      const formatSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      };
      
      document.getElementById('stat-size').innerHTML = `<span>Size:</span><strong>${formatSize(size)}</strong>`;
      document.getElementById('stat-lines').innerHTML = `<span>Lines:</span><strong>${lines}</strong>`;
    }

    // ============================================
    // Tab Switching
    // ============================================
    function switchTool(toolId) {
      AppState.currentTool = toolId;
      const tool = TOOLS[toolId];

      // Update tabs
      document.querySelectorAll('.tool-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tool === toolId);
        tab.setAttribute('aria-selected', tab.dataset.tool === toolId);
      });

      // Update options panels
      document.querySelectorAll('.tool-options').forEach(panel => {
        panel.style.display = panel.id === `options-${toolId}` ? 'block' : 'none';
      });

      // Update titles
      document.getElementById('options-tool-name').textContent = tool.name;
      document.getElementById('options-tool-desc').textContent = tool.description;
      document.getElementById('output-title').textContent = tool.outputTitle;
      document.getElementById('btn-process').textContent = tool.buttonText;

      // Update flatten button text based on operation
      if (toolId === 'flatten') {
        const op = document.getElementById('flatten-op').value;
        document.getElementById('btn-process').textContent = 
          op === 'flatten' ? 'Flatten JSON' : 'Unflatten JSON';
      }

      // Reprocess with new tool
      process();
    }

    // ============================================
    // Theme Toggle
    // ============================================
    function toggleTheme() {
      AppState.theme = AppState.theme === 'dark' ? 'light' : 'dark';
      localStorage.setItem('json-toolbox-theme', AppState.theme);
      
      document.documentElement.setAttribute('data-theme', AppState.theme);
      document.getElementById('btn-theme').textContent = AppState.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      
      AppState.inputEditor.dispatch({
        effects: AppState.themeCompartment.reconfigure(
          AppState.theme === 'dark' ? darkTheme : lightTheme
        )
      });
    }

    // ============================================
    // Utility Functions
    // ============================================
    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        const feedback = document.getElementById('copy-feedback');
        feedback.classList.add('show');
        setTimeout(() => feedback.classList.remove('show'), 2000);
      });
    }

    function setEditorContent(content) {
      AppState.inputEditor.dispatch({
        changes: {
          from: 0,
          to: AppState.inputEditor.state.doc.length,
          insert: content
        }
      });
    }

    // ============================================
    // Event Listeners
    // ============================================
    function setupEventListeners() {
      // Tab navigation
      document.querySelectorAll('.tool-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTool(tab.dataset.tool));
      });

      // Process button
      document.getElementById('btn-process').addEventListener('click', process);

      // Header buttons
      document.getElementById('btn-clear').addEventListener('click', () => {
        setEditorContent('');
        showEmptyState();
      });

      document.getElementById('btn-paste').addEventListener('click', async () => {
        try {
          const text = await navigator.clipboard.readText();
          setEditorContent(text);
        } catch (e) {
          updateStatus('error', 'Could not read clipboard');
        }
      });

      document.getElementById('btn-sample').addEventListener('click', () => {
        setEditorContent(JSON.stringify(SAMPLE_DATA, null, 3));
      });

      document.getElementById('btn-theme').addEventListener('click', toggleTheme);

      // Input pane buttons
      document.getElementById('btn-upload').addEventListener('click', () => {
        document.getElementById('file-input').click();
      });

      document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => setEditorContent(ev.target.result);
          reader.readAsText(file);
        }
        e.target.value = '';
      });

      document.getElementById('btn-format').addEventListener('click', () => {
        const input = AppState.inputEditor.state.doc.toString();
        try {
          const formatted = JSON.stringify(JSON.parse(input), null, 3);
          setEditorContent(formatted);
          updateStatus('success', 'JSON formatted');
        } catch (e) {
          updateStatus('error', 'Invalid JSON - cannot format');
        }
      });

      document.getElementById('btn-minify').addEventListener('click', () => {
        const input = AppState.inputEditor.state.doc.toString();
        try {
          const minified = JSON.stringify(JSON.parse(input));
          setEditorContent(minified);
          updateStatus('success', 'JSON minified');
        } catch (e) {
          updateStatus('error', 'Invalid JSON - cannot minify');
        }
      });

      // Output pane buttons
      document.getElementById('btn-copy').addEventListener('click', () => {
        const outputArea = document.getElementById('output-area');
        const pre = outputArea.querySelector('pre');
        if (pre) {
          copyToClipboard(pre.textContent);
        } else {
          // For HTML table output
          const table = outputArea.querySelector('.table-output');
          if (table) {
            copyToClipboard(table.innerHTML);
          }
        }
      });

      document.getElementById('btn-download').addEventListener('click', () => {
        const outputArea = document.getElementById('output-area');
        const pre = outputArea.querySelector('pre');
        if (!pre) return;
        
        const content = pre.textContent;
        const blob = new Blob([content], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${AppState.currentTool}-output.json`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // Drag & drop
      const dropZone = document.getElementById('drop-zone');
      const inputPane = document.querySelector('.pane-input');

      inputPane.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('active');
      });

      inputPane.addEventListener('dragleave', () => {
        dropZone.classList.remove('active');
      });

      inputPane.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('active');
        
        const file = e.dataTransfer.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (ev) => setEditorContent(ev.target.result);
          reader.readAsText(file);
        }
      });

      // Pane resizer
      const resizer = document.getElementById('pane-resizer');
      let isResizing = false;

      resizer.addEventListener('mousedown', (e) => {
        isResizing = true;
        resizer.classList.add('active');
      });

      document.addEventListener('mousemove', (e) => {
        if (!isResizing) return;
        
        const container = document.querySelector('.split-pane');
        const containerRect = container.getBoundingClientRect();
        const percent = ((e.clientX - containerRect.left) / containerRect.width) * 100;
        
        if (percent >= 20 && percent <= 80) {
          document.querySelector('.pane-input').style.flex = `0 0 ${percent}%`;
        }
      });

      document.addEventListener('mouseup', () => {
        isResizing = false;
        resizer.classList.remove('active');
      });

      // Flatten operation change
      document.getElementById('flatten-op').addEventListener('change', (e) => {
        document.getElementById('btn-process').textContent = 
          e.target.value === 'flatten' ? 'Flatten JSON' : 'Unflatten JSON';
      });

      // Options changes trigger reprocessing
      document.querySelectorAll('.tool-options select, .tool-options input').forEach(el => {
        el.addEventListener('change', debouncedProcess);
      });
    }

    // ============================================
    // Initialize
    // ============================================
    function init() {
      // Apply initial theme
      document.documentElement.setAttribute('data-theme', AppState.theme);
      document.getElementById('btn-theme').textContent = AppState.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      
      // Create editor
      createEditor();
      
      // Setup event listeners
      setupEventListeners();
      
      // Show empty state
      showEmptyState();
      
      console.log('JSON Toolbox initialized');
    }

    // Start app
    init();
  </script>
</body>
</html>
